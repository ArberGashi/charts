<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head th:fragment="head(pageTitle)">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${pageTitle}">ArberCharts Visual Verifier</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: dark light;
        --bg: #0a0f17;
        --panel: #121724;
        --panel-soft: rgba(18, 23, 36, 0.8);
        --text: #f1f5f9;
        --accent: #22d3ee;
        --accent-strong: #38bdf8;
        --muted: rgba(241,245,249,0.58);
        --stroke: rgba(148,163,184,0.18);
      }
      [data-theme="light"] {
        --bg: #f5f7fb;
        --panel: #ffffff;
        --panel-soft: rgba(255,255,255,0.8);
        --text: #0f172a;
        --accent: #0284c7;
        --accent-strong: #0ea5e9;
        --muted: rgba(15,23,42,0.6);
        --stroke: rgba(15,23,42,0.12);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      a {
        color: inherit;
      }
      .topbar {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(140deg, rgba(34,211,238,0.08), rgba(8,12,22,0.94));
        border-bottom: 1px solid var(--stroke);
        backdrop-filter: blur(10px);
      }
      .topbar-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 18px 32px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        letter-spacing: 0.03em;
        text-decoration: none;
      }
      .nav {
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
      }
      .nav a {
        text-decoration: none;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        color: var(--muted);
      }
      .nav a.is-active {
        border-color: var(--stroke);
        color: var(--text);
        background: rgba(34,211,238,0.12);
      }
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .page {
        padding: 24px 32px 48px;
      }
      .hero {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        align-items: center;
        padding: 24px 0;
      }
      .hero h1 {
        margin: 0 0 12px;
        font-size: 32px;
      }
      .hero p {
        margin: 0;
        color: var(--muted);
        line-height: 1.55;
      }
      .section {
        margin-top: 36px;
      }
      .section h2 {
        margin: 0 0 16px;
        font-size: 18px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }
      .grid.wide {
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 14px;
        padding: 18px;
        box-shadow: 0 14px 40px rgba(8,12,22,0.35);
      }
      .card h3 {
        margin: 0 0 12px;
        font-size: 16px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        color: var(--muted);
        font-size: 12px;
      }
      .badge {
        background: rgba(34,211,238,0.16);
        color: var(--accent-strong);
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        font-family: "IBM Plex Mono", ui-monospace, Menlo, monospace;
      }
      .badge-link {
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .badge-link:hover {
        filter: brightness(1.1);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--accent);
        border: none;
        color: #081018;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid var(--stroke);
        color: var(--text);
      }
      .btn.ghost.is-active {
        border-color: var(--accent-strong);
        color: var(--text);
        background: rgba(34,211,238,0.12);
      }
      .chart-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }
      .card-actions {
        margin-top: 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .readout {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        font-family: "IBM Plex Mono", ui-monospace, Menlo, monospace;
        font-size: 12px;
        color: var(--muted);
      }
      .readout strong {
        color: var(--text);
      }
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 12px;
      }
      .kpi-card {
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(255,255,255,0.02);
      }
      .kpi-card span {
        display: block;
        color: var(--muted);
        font-size: 12px;
      }
      .kpi-card strong {
        font-size: 14px;
        color: var(--text);
      }
      .legend {
        margin: 12px 0 0;
        padding: 0;
        list-style: none;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
      }
      .legend li {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent-strong);
        box-shadow: 0 0 0 3px rgba(34,211,238,0.15);
      }
      .legend-dot.tone-1 { background: #22d3ee; box-shadow: 0 0 0 3px rgba(34,211,238,0.12); }
      .legend-dot.tone-2 { background: #fbbf24; box-shadow: 0 0 0 3px rgba(251,191,36,0.16); }
      .legend-dot.tone-3 { background: #a855f7; box-shadow: 0 0 0 3px rgba(168,85,247,0.16); }
      .legend-dot.tone-4 { background: #22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,0.16); }
      .legend-dot.tone-5 { background: #f97316; box-shadow: 0 0 0 3px rgba(249,115,22,0.16); }
      .family-grid .card.is-featured {
        grid-column: span 2;
      }
      .showcase-mode .nav {
        display: none;
      }
      .showcase-mode .topbar {
        background: rgba(8,12,22,0.8);
      }
      .showcase-mode .page {
        padding: 16px 24px;
      }
      .showcase-mode .card {
        box-shadow: 0 16px 50px rgba(5,8,16,0.45);
      }
      .featured-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
        gap: 20px;
        margin-top: 16px;
      }
      .featured-card {
        display: grid;
        gap: 12px;
      }
      .featured-card ul {
        margin: 0;
        padding-left: 18px;
        color: var(--muted);
        font-size: 13px;
      }
      .chart-grid img {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: var(--panel-soft);
      }
      .code-block {
        margin-top: 12px;
        padding: 12px 14px;
        background: rgba(8, 12, 22, 0.45);
        border: 1px solid var(--stroke);
        border-radius: 10px;
        font-family: "IBM Plex Mono", ui-monospace, Menlo, monospace;
        font-size: 12px;
        white-space: pre-wrap;
      }
      [data-theme="light"] .code-block {
        background: rgba(248, 250, 252, 0.9);
      }
      footer {
        border-top: 1px solid var(--stroke);
        padding: 24px 32px 36px;
        color: var(--muted);
      }
      @media (max-width: 720px) {
        .topbar-inner {
          padding: 16px 20px;
          flex-direction: column;
          align-items: flex-start;
        }
        .page {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar" th:fragment="header(active)">
      <div class="topbar-inner">
        <a class="brand" href="/" aria-label="ArberCharts Visual Verifier">ArberCharts Visual Verifier</a>
        <nav class="nav">
          <a href="/" th:classappend="${active} == 'home' ? ' is-active' : ''">Home</a>
          <a href="/core" th:classappend="${active} == 'core' ? ' is-active' : ''">Core</a>
          <a href="/domains" th:classappend="${active} == 'domains' ? ' is-active' : ''">Domains</a>
          <a href="/families" th:classappend="${active} == 'families' ? ' is-active' : ''">Families</a>
          <a href="/renderers" th:classappend="${active} == 'renderers' ? ' is-active' : ''">Renderers</a>
          <a href="/performance" th:classappend="${active} == 'performance' ? ' is-active' : ''">Performance</a>
        </nav>
        <div class="toolbar">
          <button class="btn ghost" id="toggleTheme" type="button">Toggle theme</button>
          <button class="btn ghost" id="toggleShowcase" type="button">Showcase mode</button>
          <button class="btn ghost" id="toggleShowcaseTour" type="button">Auto tour</button>
        </div>
      </div>
    </header>
    <footer th:fragment="footer">
      <div>ArberCharts Visual Verifier Â· Customer-facing renderer showcase UI</div>
    </footer>
    <div th:fragment="scripts">
      <script>
        (function () {
          const body = document.body;
          const toggle = document.getElementById('toggleTheme');
          const toggleShowcase = document.getElementById('toggleShowcase');
          const toggleShowcaseTour = document.getElementById('toggleShowcaseTour');
          let showcaseTimer = null;
          let showcaseIndex = 0;
          if (toggle) {
            toggle.addEventListener('click', () => {
              body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
              refreshCharts();
            });
          }
          if (toggleShowcase) {
            toggleShowcase.addEventListener('click', () => {
              const enabled = body.classList.toggle('showcase-mode');
              if (enabled && document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
                startShowcaseTour();
              } else if (!enabled && document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(() => {});
                stopShowcaseTour();
              }
            });
          }
          if (toggleShowcaseTour) {
            toggleShowcaseTour.addEventListener('click', () => {
              if (showcaseTimer) {
                stopShowcaseTour();
              } else {
                startShowcaseTour();
              }
            });
          }

          function startShowcaseTour() {
            if (showcaseTimer) return;
            const sections = document.querySelectorAll('[data-showcase-sections] .showcase-section');
            if (!sections.length) return;
            toggleShowcaseTour && toggleShowcaseTour.classList.add('is-active');
            showcaseTimer = setInterval(() => {
              const target = sections[showcaseIndex % sections.length];
              showcaseIndex += 1;
              if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 9000);
          }

          function stopShowcaseTour() {
            if (!showcaseTimer) return;
            clearInterval(showcaseTimer);
            showcaseTimer = null;
            toggleShowcaseTour && toggleShowcaseTour.classList.remove('is-active');
          }

          const charts = document.querySelectorAll('img[data-type]');
          const rotX = document.getElementById('rotX');
          const rotY = document.getElementById('rotY');
          const rotZ = document.getElementById('rotZ');

          function pointsForType(type) {
            if (type === 'candlestick') return 6000;
            if (type === 'ecg' || type === 'medical') return 12000;
            if (type === 'heatmap') return 4096;
            if (type === 'vector') return 900;
            if (type === 'candlestick3d') return 2500;
            if (type === 'voxel') return 1400;
            return 20000;
          }

          function refreshCharts() {
            if (!charts.length) return;
            const theme = body.getAttribute('data-theme');
            const stamp = Date.now();
            charts.forEach(img => {
              const type = img.getAttribute('data-type');
              const domain = img.getAttribute('data-domain');
              const points = img.dataset.points ? Number(img.dataset.points) : pointsForType(type);
              const width = img.dataset.width ? Number(img.dataset.width) : 960;
              const height = img.dataset.height ? Number(img.dataset.height) : 560;
              const domainParam = domain ? `&domain=${domain}` : '';
              let rotParam = '';
              if (domain === 'spatial' && rotX && rotY && rotZ) {
                rotParam = `&rx=${rotX.value}&ry=${rotY.value}&rz=${rotZ.value}`;
              }
              img.src = `/api/chart/${type}?points=${points}&theme=${theme}&width=${width}&height=${height}${domainParam}${rotParam}&ts=${stamp}`;
            });
          }

          [rotX, rotY, rotZ].forEach(slider => {
            if (!slider) return;
            slider.addEventListener('input', () => {
              refreshCharts();
            });
          });

          const refreshButtons = document.querySelectorAll('[data-refresh]');
          refreshButtons.forEach(btn => {
            btn.addEventListener('click', () => refreshCharts());
          });

          const filterButtons = document.querySelectorAll('[data-filter]');
          if (filterButtons.length) {
            filterButtons.forEach(btn => {
              btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-filter');
                filterButtons.forEach(other => other.classList.remove('is-active'));
                btn.classList.add('is-active');
                document.querySelectorAll('[data-card-domain]').forEach(card => {
                  if (!target || target === 'all') {
                    card.style.display = '';
                    return;
                  }
                  card.style.display = card.getAttribute('data-card-domain') === target ? '' : 'none';
                });
              });
            });
          }

          document.querySelectorAll('.card').forEach(card => {
            const img = card.querySelector('img[data-type]');
            if (!img || card.querySelector('[data-download]')) return;
            const actions = document.createElement('div');
            actions.className = 'card-actions';
            const download = document.createElement('button');
            download.className = 'btn ghost';
            download.type = 'button';
            download.textContent = 'Download PNG';
            download.setAttribute('data-download', 'true');
            download.addEventListener('click', () => {
              const link = document.createElement('a');
              const type = img.getAttribute('data-type') || 'chart';
              link.href = img.src;
              link.download = `${type}-${Date.now()}.png`;
              document.body.appendChild(link);
              link.click();
              link.remove();
            });
            actions.appendChild(download);
            card.appendChild(actions);
          });

          const metricsTarget = document.querySelector('[data-metrics]');
          if (metricsTarget) {
            fetch('/api/metrics')
              .then(res => res.json())
              .then(metrics => {
                metricsTarget.querySelector('[data-metric="poolActive"]').textContent = metrics.poolActive;
                metricsTarget.querySelector('[data-metric="poolIdle"]').textContent = metrics.poolIdle;
                metricsTarget.querySelector('[data-metric="poolContention"]').textContent = metrics.poolContention;
              })
              .catch(() => {});
          }

          refreshCharts();
        })();
      </script>
    </div>
  </body>
</html>
